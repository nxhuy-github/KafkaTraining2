package com.nxhuy.spark.streaming.training

import org.apache.kafka.clients.producer.{ KafkaProducer, ProducerConfig, ProducerRecord }
import org.apache.spark.SparkConf
import org.apache.spark.streaming._
import org.apache.spark.streaming.kafka._
import org.apache.spark.streaming.{ Seconds, StreamingContext }
import org.apache.spark.SparkContext._
import org.apache.spark.streaming.twitter._
import org.apache.spark.SparkConf
import org.apache.spark.streaming._
import org.apache.spark.{ SparkContext, SparkConf }
import org.apache.spark.storage.StorageLevel


object KafkaSparkPopularHashTags {
  val conf = new SparkConf().setAppName("Streaming App").setMaster("local[6]")
  val sc = new SparkContext(conf)
  
  def main(args: Array[String]) {
    sc.setLogLevel("WARN")
    
    val Array(zkQuorum, group, topics, numThreads) = args
    
    val ssc = new StreamingContext(sc, Seconds(2))
    ssc.checkpoint("checkpoint")
    
    val topicMap = topics.split(",").map((_, numThreads.toInt)).toMap
    
    val lines = KafkaUtils.createStream(ssc, zkQuorum, group, topicMap).map(_._2)
    
    val hashTags = lines.flatMap(_.split(" ")).filter(_.startsWith("#"))
    
    val topCounts60 = hashTags.map((_, 1)).reduceByKeyAndWindow(_+_, Seconds(60))
    .map{case (topic, count) => (count, topic)}.transform(_.sortByKey(false))
    
    val topCounts10 = hashTags.map((_, 1)).reduceByKeyAndWindow(_+_, Seconds(10))
    .map{case (topic, count) => (count, topic)}.transform(_.sortByKey(false))
    
    lines.print()
    
    topCounts60.foreachRDD(rdd => {
      val topList = rdd.take(10)
      println("\nPopular topics in last 60s (%s total): ".format(rdd.count()))
      topList.foreach{case (count, tag) => println("%s (%s tweets)".format(tag, count))}
    })
    
    topCounts10.foreachRDD(rdd => {
      val topList = rdd.take(10)
      println("\nPopular topics in last 10s (%s total): ".format(rdd.count()))
      topList.foreach{case (count, tag) => println("%s (%s tweets)".format(tag, count))}
    })
    
    lines.count().map(cnt => "Received " + cnt + " kafka messages").print()
    
    ssc.start()
    ssc.awaitTermination()
  }
}